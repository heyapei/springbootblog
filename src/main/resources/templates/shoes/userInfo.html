<!--
  @Description: TODO 
 
  @Author    何亚培
  @Version   V1.0  
  @Date      2019/11/14 16:23 
-->
<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>用户信息查询页面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="keywords" content="票据管理系统"/>
    <link href="/static/favicon/myoperation/index.ico" mce_href="/static/favicon/myoperation/index.ico" rel="icon"
          type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap-theme.min.css"/>
    <script type="text/javascript" charset="utf-8" src="/static/bootstrap/js/jQuery.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/bootstrap/js/bootstrap.min.js"></script>


    <!--加载弹出框插件-->

    <link rel="stylesheet" type="text/css" href="/static/toastr/toastr.min.css"/>
    <script type="text/javascript" charset="utf-8" src="/static/toastr/toastr.min.js"></script>
    <!--日期选择插件-->
    <link rel="stylesheet" type="text/css" href="/static/datetimepicker/bootstrap-datetimepicker.min.css"/>
    <script type="text/javascript" charset="utf-8" src="/static/datetimepicker/moment-with-locales.min.js"></script>
    <script type="text/javascript" charset="utf-8"
            src="/static/datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" charset="utf-8"
            src="/static/datetimepicker/bootstrap-datetimepicker.zh-CN.js"></script>
    <!--数据图形化插件-->
    <script type="text/javascript" charset="utf-8" src="/static/echarts/echarts.min.js"></script>
    <!--table插件-->
    <link rel="stylesheet" type="text/css" href="/static/table/bootstrap-table.min.css"/>
    <script type="text/javascript" charset="utf-8" src="/static/table/bootstrap-table.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/table/tableExport.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/table/jquery.base64.js"></script>
    <script type="text/javascript" charset="utf-8" src="/static/table/bootstrap-table-export.js"></script>
    <!--js文件-->
    <script type="text/javascript" charset="utf-8" src="/static/shoes/js/userInfo.js"></script>

    <script>
        /*弹出框插件*/
        toastr.options = {
            closeButton: true,  //是否显示关闭按钮（提示框右上角关闭按钮）
            debug: false,  //是否为调试；
            progressBar: true,  //是否显示进度条（设置关闭的超时时间进度条）
            positionClass: "toast-top-center",  //消息框在页面显示的位置
            onclick: null,  //点击消息框自定义事件
            showDuration: "300",  //显示动作时间
            hideDuration: "1000",  //隐藏动作时间
            timeOut: "2000",  //自动关闭超时时间
            extendedTimeOut: "1000",
            showEasing: "swing",
            hideEasing: "linear",
            showMethod: "fadeIn",  //显示的方式
            hideMethod: "fadeOut"  //隐藏的方式
        };
    </script>

    <style>
        .table tbody tr td {
            text-align: center; /** 设置水平方向居中 */
            vertical-align: middle /** 设置垂直方向居中 */
        }

        .table th {
            text-align: center; /** 设置水平方向居中 */
            vertical-align: middle /** 设置垂直方向居中 */
        }


        /*翻页*/
        .jump {
            margin: 0px 0;
            float: right;
        }

        .jump_text {
            float: right;
            margin: 0 0 0 5px;
            line-height: 33px;
        }

        .jump_text input {
            width: 40px;
            border: rgba(212, 212, 212, 1.00) 1px solid;
            height: 30px;
            line-height: 33px;
            background: #fff;
        }

        /*取消number的样式*/
        /* google、safari */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }

        /* 火狐 */
        input[type="number"] {
            -moz-appearance: textfield;
        }

    </style>

</head>
<body>
<div class="container-fluid">
    <div class="row clearfix">

        <!--头部信息-->
        <div class="col-md-12 column">

            <div class="col-md-2 column">
                <div id="xiaocong_weatherforecast">

                </div>
            </div>


            <div class="col-md-8 column">
                <div class="page-header">
                    <h3 class="text-center">
                        用户信息查询
                    </h3>
                </div>
            </div>

            <div class="col-md-2 column">

            </div>

        </div>

        <!--中间信息-->
        <div class="col-md-12 column">


            <form role="form" class="form-inline" action="/home/userInfoByPage"
                  method="post" id="courseStatisticsForm">
                <div class="form-group">
                    <label for="single-courseCode" title="输入手机号进行查询">用户手机号</label>
                    <input class="form-control" id="single-courseCode" placeholder="请输入用户手机号" style="height: 30px;"
                           name="phoneNum" th:value="${phoneNum}">
                </div>

                <div class="form-group">
                    <label for="single-pageSize" title="每页所展示的条目数">每页条数</label>
                    <input class="form-control" id="single-pageSize" placeholder="条数" type="number"
                           style="height: 30px;"
                           name="pageSize" th:value="${pageResult.getData().getPageSize()}">
                </div>

                <button type="submit" class="btn">查询</button>

            </form>

            <br><br>


        </div>


        <!--显示信息-->


        <div class="col-md-12 column">

            <div class="table-responsive">
                <table class="table table-bordered table-hover" data-toggle="table" data-show-columns="true"
                       data-search="true" data-show-refresh="true" data-show-toggle="true"
                       data-export-types="['excel']" id="courseStatisticsTable">
                    <thead>
                    <tr style="white-space: nowrap;">

                        <th>
                            姓名
                        </th>
                        <th>
                            手机号
                        </th>
                        <th>
                            积分
                        </th>
                        <th>
                            生日
                        </th>
                        <th data-sortable="true">
                            创建时间
                        </th>
                        <th>
                            操作
                        </th>


                    </tr>
                    </thead>
                    <tbody>

                    <tr th:each="user,userStat : ${pageResult.data.list}">

                        <td th:text="${user.realName}">
                        </td>

                        <td th:text="${user.phoneNum}">
                        </td>
                        <td th:text="${user.empirical}">
                        </td>
                        <td th:text="${#dates.format(user.birthday, 'yyyy/MM/dd')}">
                        </td>

                        <td th:text="${#dates.format(user.createTime, 'yyyy/MM/dd hh:mm:ss')}">

                        </td>

                        <td>

                            <a target="_blank" th:href="'/home/addOrderPage?userId='+${user.id}"
                               class='btn btn-xs green' title='订单添加'
                            ><span class='glyphicon glyphicon-plus'></span></a>

                            <a th:href="'/home/orderInfoByPage?orderInfo-phoneNum='+${user.phoneNum}"
                               class='btn btn-xs green' title='查看用户订单'
                            ><span class='glyphicon glyphicon-search'></span></a>

                            <!--glyphicon glyphicon-user-->
                            <!--glyphicon glyphicon-search-->
                            <a href="javascript:" class='btn btn-xs green' title='用户分析'
                               th:onclick="|showUserBuy(${user.id})|"
                            ><span class="glyphicon glyphicon-user"></span></a>

                            <a href="javascript:" class='btn btn-xs green' title='修改用户信息'
                               th:onclick="|getUserInfoByUserId(${user.id})|"
                            ><span class='glyphicon glyphicon-pencil'></span></a>

                        </td>

                    </tr>

                    </tbody>
                </table>
            </div>

            <nav>
                <!-- <ul class="pagination">

                     <li>
                         <a th:href="|javascript:cp(1)|">首页</a>
                     </li>


                     <li class="prev" th:if="${pageResult.data.hasPreviousPage}">
                         <a th:href="|javascript:cp(${pageResult.data.prePage})|">
                             <i class="ace-icon fa fa-angle-double-left"></i>
                         </a>
                     </li>
                     &lt;!&ndash;遍历条数&ndash;&gt;
                     <li th:each="nav:${pageResult.data.navigatepageNums}">
                         <a th:href="|javascript:cp(${nav})|" th:text="${nav}"
                            th:if="${nav != pageResult.data.pageNum}"></a>
                         <span style="font-weight: bold;background: #6faed9;" th:if="${nav == pageResult.data.pageNum}"
                               th:text="${nav}"></span>
                     </li>

                     <li class="next" th:if="${pageResult.data.hasNextPage}">
                         <a th:href="|javascript:cp(${pageResult.data.nextPage})|">
                             <i class="ace-icon fa fa-angle-double-right"></i>
                         </a>
                     </li>

                     <li>
                         <a th:href="|javascript:cp(${pageResult.data.pages})|">尾页</a>
                     </li>
                 </ul>-->

                <ul class="pagination">
                    <li th:class="${indexPage==1}?'disabled' : ''"><a th:href="|javascript:cp(${indexPage-1})|">上一页</a>
                    </li>
                    <li th:if="${indexPage-3 >=1}"><a th:href="|javascript:cp(${indexPage-3})|"
                                                      th:text="${indexPage -3}">1</a></li>
                    <li th:if="${indexPage-2 >=1}"><a th:href="|javascript:cp(${indexPage-2})|"
                                                      th:text="${indexPage -2}">1</a></li>
                    <li th:if="${indexPage-1 >=1}"><a th:href="|javascript:cp(${indexPage-1})|"
                                                      th:text="${indexPage -1}">1</a></li>
                    <li class="active"><a href="#" th:text="${indexPage}">1</a></li>
                    <li th:if="${indexPage+1 <=totalPage}"><a th:href="|javascript:cp(${indexPage+1})|"
                                                              th:text="${indexPage +1}">1</a></li>
                    <li th:if="${indexPage+2 <=totalPage}"><a th:href="|javascript:cp(${indexPage+2})|"
                                                              th:text="${indexPage +2}">1</a></li>
                    <li th:if="${indexPage+3 <=totalPage}"><a th:href="|javascript:cp(${indexPage+3})|"
                                                              th:text="${indexPage +3}">1</a></li>

                    <li th:class="${indexPage==totalPage}?'disabled' : ''"><a th:href="|javascript:cp(${indexPage+1})|">下一页</a>
                    </li>
                </ul>


                <div class="jump">
                            <span class="jump_text">
                                当前<label th:title="'当前共有'+${pageResult.getData().getSize()}+'条目录'"
                                         th:text="${pageResult.getData().getSize()}"></label>/<label
                                    th:title="'每页显示'+${pageResult.getData().getPageSize()}+'条目录'"
                                    th:text="${pageResult.getData().getPageSize()}"></label>条 | <label
                                    th:title="'当前在第'+${pageResult.getData().getPageNum()}+'页'"
                                    th:text="${pageResult.getData().getPageNum()}"></label>/<label
                                    th:title="'总共'+${pageResult.getData().getPages()}+'页'"
                                    th:text="${pageResult.getData().getPages()}"></label>页,跳到
                                <input type="number" name="jumpPage"
                                       id="jumpPage" th:value="${pageResult.getData().getPageNum()}"
                                       οnkeyup="this.value=this.value.replace(/[^0-9-]+/,'');">页
                                <button type="button" class="btn btn-primary btn-sm"
                                        th:onclick="|javascript:goPage(${pageResult.getData().getTotal()})|">跳转</button>
                            </span>
                </div>


            </nav>
        </div>


    </div>
</div>


<!--模态框 展示趋势图-->

<div id="myModal" class="modal fade bs-example-modal-lg">
    <div class="modal-dialog modal-lg" style="height: 50%;width: 100%">
        <div class="modal-content" style="height: 100%;width: 100%">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="myModalTitle">Welcome Back!</h4>
            </div>
            <div class="modal-body" style="height: 90%;">
                <div id="echartsContainer" style="height: 100%;">

                </div>
            </div>


        </div>
    </div>
</div>

<form class="form-horizontal" role="form">
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <!--  定义模态框，过渡效果为淡入，id为myModal,tabindex=-1可以禁用使用tab切换，aria-labelledby用于引用模态框的标题，aria-hidden=true保持模态框在触发前窗口不可见  -->
        <div class="modal-dialog">
            <!--  显示模态框对话框模型（若不写下一个div则没有颜色）  -->
            <div class="modal-content">
                <!--  显示模态框白色背景，所有内容都写在这个div里面  -->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4>修改用户信息</h4>
                </div>

                <div class="modal-body">
                    <!--  模态框内容，我在此处添加一个表单 -->
                    <input type="hidden" id="userId" name="userId">
                    <div class="form-group">
                        <label for="phoneNum" class="col-sm-2 control-label">手机号</label>
                        <div class="col-sm-9">
                            <input type="tel" id="phoneNum" name="phoneNum" class="form-control well"
                                   placeholder="请输入手机号" required/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="realName" class="col-sm-2 control-label">用户姓名</label>
                        <div class="col-sm-9">
                            <input type="text" id="realName" name="realName" class="form-control well"
                                   placeholder="请输入用户名" required/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="birthday" class="col-sm-2 control-label">出生日期</label>
                        <div class="col-sm-9">
                            <input type="date" id="birthday" name="birthday" class="form-control well"
                                   placeholder="请输入出生日期" required/>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-info" onclick="updateUserInfo()">确认更新</button>
                    <button type="button" class="btn btn-info" data-dismiss="modal">取消更新</button>
                    <button type="button" class="btn btn-danger" onclick="confirm()">删除用户</button>
                </div>

            </div>
        </div>
    </div>
</form>


<div class="modal fade" id="showUserBuy" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <!--  定义模态框，过渡效果为淡入，id为myModal,tabindex=-1可以禁用使用tab切换，aria-labelledby用于引用模态框的标题，aria-hidden=true保持模态框在触发前窗口不可见  -->
    <div class="modal-dialog modal-lg">
        <!--  显示模态框对话框模型（若不写下一个div则没有颜色）  -->
        <div class="modal-content">
            <!--  显示模态框白色背景，所有内容都写在这个div里面  -->
            <!--<div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4>用户购买总结</h4>
            </div>-->

            <div class="modal-body">
                <fieldset>
                    <legend>数据为用户最近365天的购买总结</legend>

                    <div class="table-responsive">
                        <table class="table  table-bordered table-condensed">
                            <tbody>
                            <tr>
                                <td>
                                    消费总额
                                </td>
                                <td id="realMoney">
                                </td>
                                <td>
                                    订单数量
                                </td>
                                <td id="orderNum">
                                </td>
                                <td>
                                    商品数量
                                </td>
                                <td id="shoesNum">
                                </td>
                                <td>
                                    平均每单
                                </td>
                                <td id="orderAverage">
                                </td>
                                <td>
                                    平均每双
                                </td>
                                <td id="shoesAverage">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="showUserBuyChart" style="width: 100%;height: 400px">

                    </div>
                </fieldset>


            </div>
        </div>
    </div>
</div>


<script>

    function showUserBuy(userId) {

        $('#showUserBuy').modal("show");
        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('showUserBuyChart'));
        myChart.showLoading();

        $.ajax({
            type: "GET",
            url: "/home/showUserBuy?userId=" + userId,
            timeout: 5000,
            success: function (data) {

                var shoesNum = data.shoesNum[0];
                var orderAverage = data.orderAverage[0];
                var orderNum = data.orderNum[0];
                var realMoney = data.realMoney[0];
                var shoesAverage = data.shoesAverage[0];
                $("#shoesNum").text(shoesNum);
                $("#orderAverage").text(orderAverage);
                $("#orderNum").text(orderNum);
                $("#realMoney").text(realMoney);
                $("#shoesAverage").text(shoesAverage);

                var buyDate = data.buyDate;
                var buyNum = data.buyNum;
                var shoesAve = data.shoesAve;


                /* var option = {
                     /!*title: {
                           text: '数据为用户最近365天的购买总结'
                       },*!/
                     color: ['#3398DB'],
                     tooltip: {
                         trigger: 'axis',
                         axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                             type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                         }
                     },
                     toolbox: {
                         show: true,
                         feature: {
                             dataView: {readOnly: false},
                             saveAsImage: {}
                         }
                     },
                     grid: {
                         left: '3%',
                         right: '4%',
                         bottom: '3%',
                         containLabel: true
                     },
                     xAxis: [
                         {
                             type: 'category',
                             data: buyDate,
                             axisTick: {
                                 alignWithLabel: true
                             }
                         }
                     ],
                     yAxis: [
                         {
                             type: 'value'
                         }
                     ],
                     series: [
                         {
                             name: '商品数量',
                             type: 'bar',
                             barWidth: '60%',
                             data: buyNum
                         },
                     ]
                 };*/


                var colors = ['#5793f3', '#d14a61', '#675bba'];

                var option = {
                    color: colors,

                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    grid: {
                        right: '20%'
                    },
                    toolbox: {
                        feature: {
                            dataView: {show: true, readOnly: false},
                            saveAsImage: {show: true}
                        }
                    },
                    legend: {
                        data: ['购买量', '平均金额']
                    },
                    dataZoom: [{
                        type: 'inside',
                        start: 50,
                        end: 100,
                    }, {
                        start: 0,
                        end: 100,
                        handleSize: '80%',
                        handleStyle: {
                            color: '#fff',
                            shadowBlur: 3,
                            shadowColor: 'rgba(0, 0, 0, 0.6)',
                            shadowOffsetX: 2,
                            shadowOffsetY: 2
                        }
                    }],
                    xAxis: [
                        {
                            type: 'category',
                            axisTick: {
                                alignWithLabel: true
                            },
                            data: buyDate
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '购买量',
                            position: 'right',
                            axisLine: {
                                lineStyle: {
                                    color: colors[0]
                                }
                            },
                            axisLabel: {
                                formatter: '{value} 双'
                            }
                        },
                        {
                            type: 'value',
                            name: '平均金额',

                            position: 'left',
                            axisLine: {
                                lineStyle: {
                                    color: colors[1]
                                }
                            },
                            axisLabel: {
                                formatter: '{value} 元'
                            }
                        }
                    ],
                    series: [
                        {
                            name: '购买量',
                            type: 'bar',
                            data: buyNum
                        },
                        {
                            name: '平均金额',
                            type: 'line',
                            yAxisIndex: 1,
                            data: shoesAve
                        }
                    ]
                };


                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);
                myChart.hideLoading();
                window.addEventListener("resize", function () {
                    myChart.resize();
                });

                $('#showUserBuy').on('shown.bs.modal', function () {
                    myChart.resize()
                })

            },
            error: function (data, type, err) {  // 以下依次是返回过来的数据，错误类型，错误码
                console.log("ajax错误类型：" + type);
                console.log(err);
            }
        });
    }

    function updateUserInfo() {
        var userId = $("#userId").val();
        var phoneNum = $("#phoneNum").val();
        var realName = $("#realName").val();
        var birthday = $("#birthday").val();
        $.ajax({
            url: "/home/updateUser",
            data: {userId: userId, phoneNum: phoneNum, realName: realName, birthday: birthday},
            type: "POST",
            timeout: 5000,
            dataType: "json",
            cache: false,
            success: function (d) {
                if (d.code == 200) {
                    /*$('#updateModal').modal('hide');
                    toastr.success("更新成功");*/
                    window.location.reload();
                } else {
                    toastr.error("发生错误！原因：" + d.message);
                }
            }, error: function (data, type, err) {  // 以下依次是返回过来的数据，错误类型，错误码
                console.log("ajax错误类型：" + type);
                console.log(err);
            }

        });
    }


    function getUserInfoByUserId(userId) {
        $.ajax({
            url: "/home/getUserInfoByUserId",
            data: {userId: userId},
            type: "POST",
            timeout: 5000,
            dataType: "json",
            cache: false,
            success: function (d) {
                if (d.code == 200) {
                    $('#updateModal').modal("show");
                    $("#userId").val(d.data.id);
                    $("#phoneNum").val(d.data.phoneNum);
                    $("#realName").val(d.data.realName);

                    var date = new Date();
                    date.setTime(d.data.birthday);
                    var mon = date.getMonth() + 1;
                    var day = date.getDate();
                    var myDate = date.getFullYear() + "-" + (mon < 10 ? "0" + mon : mon) + "-" + (day < 10 ? "0" + day : day);
                    document.getElementById("birthday").value = myDate;

                } else {
                    toastr.error("发生错误！原因：" + d.message);
                }
            }, error: function (data, type, err) {  // 以下依次是返回过来的数据，错误类型，错误码
                console.log("ajax错误类型：" + type);
                console.log(err);
            }

        });
    }


    function deleteUser() {
        var userId = $("#userId").val();
        $.ajax({
            url: "/home/deleteUser",
            data: {userId: userId},
            type: "POST",
            timeout: 5000,
            dataType: "json",
            cache: false,
            success: function (d) {
                if (d.code == 200) {
                    toastr.success("删除成功");
                    window.location.reload();
                } else {
                    toastr.error("发生错误！原因：" + d.message);
                }
            }, error: function (data, type, err) {  // 以下依次是返回过来的数据，错误类型，错误码
                console.log("ajax错误类型：" + type);
                console.log(err);
            }

        });


    }

    /**
     * 重写确认框 fun:函数对象 params:参数列表， 可以是数组
     */
    function confirm() {
        if ($("#myConfirm").length > 0) {
            $("#myConfirm").remove();
        }
        var html = "<div class='modal fade' id='myConfirm' >"
            + "<div class='modal-backdrop in' style='opacity:0; '></div>"
            + "<div class='modal-dialog' style='z-index:2901; margin-top:60px; width:400px; '>"
            + "<div class='modal-content'>"
            + "<div class='modal-header'  style='font-size:16px; '>"
            + "<span class='glyphicon glyphicon-envelope'>&nbsp;</span>信息！<button type='button' class='close' data-dismiss='modal'>"
            + "<span style='font-size:20px;  ' class='glyphicon glyphicon-remove'></span><tton></div>"
            + "<div class='modal-body text-center' id='myConfirmContent' style='font-size:18px; '>"
            + "是否确定要删除该用户？该操作无法还原，请谨慎操作"
            + "</div>"
            + "<div class='modal-footer ' style=''>"
            + "<button class='btn btn-danger ' id='confirmOk' >确定<tton>"
            + "<button class='btn btn-info ' data-dismiss='modal'>取消<tton>"
            + "</div>" + "</div></div></div>";
        $("body").append(html);

        $("#myConfirm").modal("show");

        $("#confirmOk").on("click", function () {
            $("#myConfirm").modal("hide");
            $('#updateModal').modal('hide');
            deleteUser(); // 执行函数
        });
    }


</script>


</body>
</html>